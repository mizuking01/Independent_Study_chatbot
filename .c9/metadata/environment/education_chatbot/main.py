{"filter":false,"title":"main.py","tooltip":"/education_chatbot/main.py","undoManager":{"mark":61,"position":61,"stack":[[{"start":{"row":17,"column":30},"end":{"row":17,"column":31},"action":"remove","lines":["u"],"id":142},{"start":{"row":17,"column":29},"end":{"row":17,"column":30},"action":"remove","lines":["o"]},{"start":{"row":17,"column":28},"end":{"row":17,"column":29},"action":"remove","lines":["y"]},{"start":{"row":17,"column":27},"end":{"row":17,"column":28},"action":"remove","lines":["r"]},{"start":{"row":17,"column":26},"end":{"row":17,"column":27},"action":"remove","lines":["i"]},{"start":{"row":17,"column":25},"end":{"row":17,"column":26},"action":"remove","lines":["s"]},{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"remove","lines":["i"]},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"remove","lines":["g"]},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"remove","lines":["u"]},{"start":{"row":17,"column":21},"end":{"row":17,"column":22},"action":"remove","lines":["o"]}],[{"start":{"row":17,"column":20},"end":{"row":17,"column":21},"action":"remove","lines":["k"],"id":143}],[{"start":{"row":17,"column":20},"end":{"row":17,"column":21},"action":"insert","lines":["s"],"id":144},{"start":{"row":17,"column":21},"end":{"row":17,"column":22},"action":"insert","lines":["o"]},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"insert","lines":["f"]},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"insert","lines":["t"]},{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"insert","lines":["w"]},{"start":{"row":17,"column":25},"end":{"row":17,"column":26},"action":"insert","lines":["a"]},{"start":{"row":17,"column":26},"end":{"row":17,"column":27},"action":"insert","lines":["r"]}],[{"start":{"row":17,"column":27},"end":{"row":17,"column":28},"action":"insert","lines":["e"],"id":145}],[{"start":{"row":18,"column":36},"end":{"row":18,"column":37},"action":"remove","lines":["考"],"id":146},{"start":{"row":18,"column":35},"end":{"row":18,"column":36},"action":"remove","lines":["参"]}],[{"start":{"row":18,"column":35},"end":{"row":18,"column":37},"action":"insert","lines":["回答"],"id":147}],[{"start":{"row":22,"column":0},"end":{"row":22,"column":29},"action":"remove","lines":["    \"\"\"複数のフォルダをまとめてインデックス化\"\"\""],"id":148},{"start":{"row":21,"column":45},"end":{"row":22,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":0,"column":0},"end":{"row":73,"column":0},"action":"remove","lines":["import os","import streamlit as st","from dotenv import load_dotenv","from datetime import datetime  ","from file_loader import load_pdf","from file_loader import load_text","from file_loader import load_docx","from text_splitter import split_text","from faiss_indexer import load_and_index_folder, search_index, create_faiss_index","","# 環境変数のロード（必要に応じて）","load_dotenv()","","# Streamlitのヘッダー","st.title(\"質問応答チャットボット\")","","# フォルダのパス","lecture_folder = \"./software\"  # 講義資料フォルダ","example_folder = \"./examples\"    # 回答例フォルダ","","# インデックスの作成","def load_and_index_multiple_folders(folders):","    all_texts = []","    for folder in folders:","        texts = load_and_index_folder(folder, return_documents=True)","        all_texts.extend(texts)","    return create_faiss_index(all_texts)","","# 講義資料と参考例を統合したインデックスを作成","combined_index = load_and_index_multiple_folders([lecture_folder, example_folder])","","# セッションステートでメッセージの履歴を保持","if \"messages\" not in st.session_state:","    st.session_state.messages = []","","# 既存のメッセージをブラウザ上に表示","for message in st.session_state.messages:","    with st.chat_message(message[\"role\"]):","        st.markdown(message[\"content\"])","","# ユーザー入力","query = st.chat_input(\"質問を入力してください:\")","","# 質問が入力された場合の応答処理","if query:","    # ユーザーメッセージをセッションに追加し表示","    st.session_state.messages.append({\"role\": \"user\", \"content\": query})","    with st.chat_message(\"user\"):","        st.markdown(query)","","    # 統合インデックスで回答を生成","    response = search_index(combined_index, query)","","    with st.chat_message(\"assistant\"):","        st.markdown(response)","","    # 応答メッセージをセッションに保存","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": response})","","# 履歴を出力する処理","def save_conversation_log():","    # 動的なファイル名を生成（例: conversation_log_20241203_141530.txt）","    timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")","    log_file_path = f\"conversation_log_{timestamp}.txt\"","    with open(log_file_path, \"w\", encoding=\"utf-8\") as log_file:","        for message in st.session_state.messages:","            role = \"ユーザー\" if message[\"role\"] == \"user\" else \"アシスタント\"","            log_file.write(f\"{role}: {message['content']}\\n\")","","# 会話終了ボタン","if st.button(\"会話を終了\"):","    save_conversation_log()","    st.info(\"会話が終了しました。\")",""],"id":149},{"start":{"row":0,"column":0},"end":{"row":76,"column":0},"action":"insert","lines":["import os","import streamlit as st","from dotenv import load_dotenv","from datetime import datetime  ","from file_loader import load_pdf","from file_loader import load_text","from file_loader import load_docx","from text_splitter import split_text","from faiss_indexer import load_and_index_folder, search_index, create_faiss_index","","# 環境変数のロード（必要に応じて）","load_dotenv()","","# Streamlitのヘッダー","st.title(\"質問応答チャットボット\")","","# フォルダのパス","lecture_folder = \"./software\"  # 講義資料フォルダ","example_folder = \"./examples\"  # 回答例フォルダ","log_folder = \"./logs\"          # 会話ログ保存フォルダ","","# インデックスの作成","def load_and_index_multiple_folders(folders):","    all_texts = []","    for folder in folders:","        texts = load_and_index_folder(folder, return_documents=True)","        all_texts.extend(texts)","    return create_faiss_index(all_texts)","","# 講義資料と参考例を統合したインデックスを作成","combined_index = load_and_index_multiple_folders([lecture_folder, example_folder])","","# セッションステートでメッセージの履歴を保持","if \"messages\" not in st.session_state:","    st.session_state.messages = []","","# 既存のメッセージをブラウザ上に表示","for message in st.session_state.messages:","    with st.chat_message(message[\"role\"]):","        st.markdown(message[\"content\"])","","# ユーザー入力","query = st.chat_input(\"質問を入力してください:\")","","# 質問が入力された場合の応答処理","if query:","    # ユーザーメッセージをセッションに追加し表示","    st.session_state.messages.append({\"role\": \"user\", \"content\": query})","    with st.chat_message(\"user\"):","        st.markdown(query)","","    # 統合インデックスで回答を生成","    response = search_index(combined_index, query)","","    with st.chat_message(\"assistant\"):","        st.markdown(response)","","    # 応答メッセージをセッションに保存","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": response})","","# 履歴を出力する処理","def save_conversation_log():","    # 保存先フォルダの存在確認と作成","    os.makedirs(log_folder, exist_ok=True)","    # 動的なファイル名を生成","    timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")","    log_file_path = os.path.join(log_folder, f\"conversation_log_{timestamp}.txt\")","    with open(log_file_path, \"w\", encoding=\"utf-8\") as log_file:","        for message in st.session_state.messages:","            role = \"ユーザー\" if message[\"role\"] == \"user\" else \"アシスタント\"","            log_file.write(f\"{role}: {message['content']}\\n\")","","# 会話終了ボタン","if st.button(\"会話を終了\"):","    save_conversation_log()","    st.info(f\"会話ログが {log_folder} に保存されました。\")",""]}],[{"start":{"row":75,"column":32},"end":{"row":75,"column":33},"action":"remove","lines":[" "],"id":150},{"start":{"row":75,"column":31},"end":{"row":75,"column":32},"action":"remove","lines":["}"]},{"start":{"row":75,"column":30},"end":{"row":75,"column":31},"action":"remove","lines":["r"]},{"start":{"row":75,"column":29},"end":{"row":75,"column":30},"action":"remove","lines":["e"]},{"start":{"row":75,"column":28},"end":{"row":75,"column":29},"action":"remove","lines":["d"]},{"start":{"row":75,"column":27},"end":{"row":75,"column":28},"action":"remove","lines":["l"]},{"start":{"row":75,"column":26},"end":{"row":75,"column":27},"action":"remove","lines":["o"]},{"start":{"row":75,"column":25},"end":{"row":75,"column":26},"action":"remove","lines":["f"]},{"start":{"row":75,"column":24},"end":{"row":75,"column":25},"action":"remove","lines":["_"]},{"start":{"row":75,"column":23},"end":{"row":75,"column":24},"action":"remove","lines":["g"]}],[{"start":{"row":75,"column":22},"end":{"row":75,"column":23},"action":"remove","lines":["o"],"id":151},{"start":{"row":75,"column":21},"end":{"row":75,"column":22},"action":"remove","lines":["l"]},{"start":{"row":75,"column":20},"end":{"row":75,"column":21},"action":"remove","lines":["{"]},{"start":{"row":75,"column":19},"end":{"row":75,"column":20},"action":"remove","lines":[" "]}],[{"start":{"row":75,"column":27},"end":{"row":75,"column":28},"action":"remove","lines":["。"],"id":152},{"start":{"row":75,"column":26},"end":{"row":75,"column":27},"action":"remove","lines":["た"]},{"start":{"row":75,"column":25},"end":{"row":75,"column":26},"action":"remove","lines":["し"]},{"start":{"row":75,"column":24},"end":{"row":75,"column":25},"action":"remove","lines":["ま"]},{"start":{"row":75,"column":23},"end":{"row":75,"column":24},"action":"remove","lines":["れ"]},{"start":{"row":75,"column":22},"end":{"row":75,"column":23},"action":"remove","lines":["さ"]},{"start":{"row":75,"column":21},"end":{"row":75,"column":22},"action":"remove","lines":["存"]},{"start":{"row":75,"column":20},"end":{"row":75,"column":21},"action":"remove","lines":["保"]},{"start":{"row":75,"column":19},"end":{"row":75,"column":20},"action":"remove","lines":["に"]},{"start":{"row":75,"column":18},"end":{"row":75,"column":19},"action":"remove","lines":["が"]},{"start":{"row":75,"column":17},"end":{"row":75,"column":18},"action":"remove","lines":["グ"]},{"start":{"row":75,"column":16},"end":{"row":75,"column":17},"action":"remove","lines":["ロ"]}],[{"start":{"row":75,"column":16},"end":{"row":75,"column":17},"action":"insert","lines":["g"],"id":153},{"start":{"row":75,"column":17},"end":{"row":75,"column":18},"action":"insert","lines":["a"]}],[{"start":{"row":75,"column":17},"end":{"row":75,"column":18},"action":"remove","lines":["a"],"id":154},{"start":{"row":75,"column":16},"end":{"row":75,"column":17},"action":"remove","lines":["g"]}],[{"start":{"row":75,"column":16},"end":{"row":75,"column":17},"action":"insert","lines":["が"],"id":155}],[{"start":{"row":75,"column":17},"end":{"row":75,"column":23},"action":"insert","lines":["終了しました"],"id":156}],[{"start":{"row":17,"column":28},"end":{"row":17,"column":29},"action":"insert","lines":["1"],"id":157},{"start":{"row":17,"column":29},"end":{"row":17,"column":30},"action":"insert","lines":["1"]}],[{"start":{"row":18,"column":28},"end":{"row":18,"column":29},"action":"insert","lines":["1"],"id":158},{"start":{"row":18,"column":29},"end":{"row":18,"column":30},"action":"insert","lines":["1"]}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":30},"action":"remove","lines":["examples11"],"id":159},{"start":{"row":18,"column":20},"end":{"row":18,"column":31},"action":"insert","lines":["examples11/"]}],[{"start":{"row":18,"column":30},"end":{"row":18,"column":31},"action":"remove","lines":["/"],"id":160}],[{"start":{"row":17,"column":29},"end":{"row":17,"column":30},"action":"remove","lines":["1"],"id":161},{"start":{"row":17,"column":28},"end":{"row":17,"column":29},"action":"remove","lines":["1"]},{"start":{"row":17,"column":27},"end":{"row":17,"column":28},"action":"remove","lines":["e"]},{"start":{"row":17,"column":26},"end":{"row":17,"column":27},"action":"remove","lines":["r"]},{"start":{"row":17,"column":25},"end":{"row":17,"column":26},"action":"remove","lines":["a"]},{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"remove","lines":["w"]},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"remove","lines":["t"]},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"remove","lines":["f"]},{"start":{"row":17,"column":21},"end":{"row":17,"column":22},"action":"remove","lines":["o"]},{"start":{"row":17,"column":20},"end":{"row":17,"column":21},"action":"remove","lines":["s"]}],[{"start":{"row":17,"column":20},"end":{"row":17,"column":39},"action":"insert","lines":["Network_Engineering"],"id":162}],[{"start":{"row":18,"column":29},"end":{"row":18,"column":30},"action":"remove","lines":["1"],"id":163},{"start":{"row":18,"column":28},"end":{"row":18,"column":29},"action":"remove","lines":["1"]},{"start":{"row":18,"column":27},"end":{"row":18,"column":28},"action":"remove","lines":["s"]},{"start":{"row":18,"column":26},"end":{"row":18,"column":27},"action":"remove","lines":["e"]},{"start":{"row":18,"column":25},"end":{"row":18,"column":26},"action":"remove","lines":["l"]},{"start":{"row":18,"column":24},"end":{"row":18,"column":25},"action":"remove","lines":["p"]},{"start":{"row":18,"column":23},"end":{"row":18,"column":24},"action":"remove","lines":["m"]},{"start":{"row":18,"column":22},"end":{"row":18,"column":23},"action":"remove","lines":["a"]},{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"remove","lines":["x"]},{"start":{"row":18,"column":20},"end":{"row":18,"column":21},"action":"remove","lines":["e"]}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":39},"action":"insert","lines":["Network_Engineering"],"id":164}],[{"start":{"row":18,"column":39},"end":{"row":18,"column":40},"action":"insert","lines":["_"],"id":165},{"start":{"row":18,"column":40},"end":{"row":18,"column":41},"action":"insert","lines":["e"]},{"start":{"row":18,"column":41},"end":{"row":18,"column":42},"action":"insert","lines":["x"]},{"start":{"row":18,"column":42},"end":{"row":18,"column":43},"action":"insert","lines":["a"]}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":43},"action":"remove","lines":["Network_Engineering_exa"],"id":166},{"start":{"row":18,"column":20},"end":{"row":18,"column":49},"action":"insert","lines":["Network_Engineering_examples/"]}],[{"start":{"row":18,"column":48},"end":{"row":18,"column":49},"action":"remove","lines":["/"],"id":167}],[{"start":{"row":18,"column":26},"end":{"row":18,"column":27},"action":"remove","lines":["k"],"id":168},{"start":{"row":18,"column":25},"end":{"row":18,"column":26},"action":"remove","lines":["r"]},{"start":{"row":18,"column":24},"end":{"row":18,"column":25},"action":"remove","lines":["o"]},{"start":{"row":18,"column":23},"end":{"row":18,"column":24},"action":"remove","lines":["w"]},{"start":{"row":18,"column":22},"end":{"row":18,"column":23},"action":"remove","lines":["t"]},{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"remove","lines":["e"]},{"start":{"row":18,"column":20},"end":{"row":18,"column":21},"action":"remove","lines":["N"]}],[{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"remove","lines":["E"],"id":169}],[{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"insert","lines":["e"],"id":170}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":21},"action":"insert","lines":["s"],"id":171},{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"insert","lines":["o"]},{"start":{"row":18,"column":22},"end":{"row":18,"column":23},"action":"insert","lines":["f"]},{"start":{"row":18,"column":23},"end":{"row":18,"column":24},"action":"insert","lines":["t"]},{"start":{"row":18,"column":24},"end":{"row":18,"column":25},"action":"insert","lines":["w"]},{"start":{"row":18,"column":25},"end":{"row":18,"column":26},"action":"insert","lines":["a"]},{"start":{"row":18,"column":26},"end":{"row":18,"column":27},"action":"insert","lines":["r"]},{"start":{"row":18,"column":27},"end":{"row":18,"column":28},"action":"insert","lines":["e"]}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":28},"action":"remove","lines":["software"],"id":172},{"start":{"row":18,"column":20},"end":{"row":18,"column":49},"action":"insert","lines":["software_engineering_exaples/"]}],[{"start":{"row":18,"column":48},"end":{"row":18,"column":70},"action":"remove","lines":["/_engineering_examples"],"id":173}],[{"start":{"row":17,"column":22},"end":{"row":17,"column":27},"action":"remove","lines":["twork"],"id":174},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"insert","lines":["s"]},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"insert","lines":["o"]},{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"insert","lines":["f"]},{"start":{"row":17,"column":25},"end":{"row":17,"column":26},"action":"insert","lines":["t"]},{"start":{"row":17,"column":26},"end":{"row":17,"column":27},"action":"insert","lines":["w"]},{"start":{"row":17,"column":27},"end":{"row":17,"column":28},"action":"insert","lines":["a"]},{"start":{"row":17,"column":28},"end":{"row":17,"column":29},"action":"insert","lines":["r"]},{"start":{"row":17,"column":29},"end":{"row":17,"column":30},"action":"insert","lines":["e"]}],[{"start":{"row":17,"column":31},"end":{"row":17,"column":32},"action":"remove","lines":["E"],"id":175}],[{"start":{"row":17,"column":31},"end":{"row":17,"column":32},"action":"insert","lines":["e"],"id":176}],[{"start":{"row":17,"column":21},"end":{"row":17,"column":22},"action":"remove","lines":["e"],"id":177},{"start":{"row":17,"column":20},"end":{"row":17,"column":21},"action":"remove","lines":["N"]}],[{"start":{"row":18,"column":44},"end":{"row":18,"column":45},"action":"insert","lines":[","],"id":178}],[{"start":{"row":18,"column":44},"end":{"row":18,"column":45},"action":"remove","lines":[","],"id":179}],[{"start":{"row":18,"column":44},"end":{"row":18,"column":45},"action":"insert","lines":["m"],"id":180}],[{"start":{"row":17,"column":27},"end":{"row":17,"column":28},"action":"remove","lines":["e"],"id":181},{"start":{"row":17,"column":26},"end":{"row":17,"column":27},"action":"remove","lines":["r"]},{"start":{"row":17,"column":25},"end":{"row":17,"column":26},"action":"remove","lines":["a"]},{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"remove","lines":["w"]},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"remove","lines":["t"]},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"remove","lines":["f"]},{"start":{"row":17,"column":21},"end":{"row":17,"column":22},"action":"remove","lines":["o"]},{"start":{"row":17,"column":20},"end":{"row":17,"column":21},"action":"remove","lines":["s"]}],[{"start":{"row":17,"column":20},"end":{"row":17,"column":21},"action":"insert","lines":["N"],"id":182},{"start":{"row":17,"column":21},"end":{"row":17,"column":22},"action":"insert","lines":["e"]},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"insert","lines":["t"]},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"insert","lines":["o"]},{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"insert","lines":["\\"]}],[{"start":{"row":17,"column":24},"end":{"row":17,"column":25},"action":"remove","lines":["\\"],"id":183},{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"remove","lines":["o"]}],[{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"insert","lines":[" "],"id":184}],[{"start":{"row":17,"column":23},"end":{"row":17,"column":24},"action":"remove","lines":[" "],"id":185},{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"remove","lines":["t"]}],[{"start":{"row":17,"column":22},"end":{"row":17,"column":23},"action":"insert","lines":["t"],"id":186}],[{"start":{"row":17,"column":20},"end":{"row":17,"column":23},"action":"remove","lines":["Net"],"id":187},{"start":{"row":17,"column":20},"end":{"row":17,"column":40},"action":"insert","lines":["Network_Engineering/"]}],[{"start":{"row":17,"column":51},"end":{"row":17,"column":52},"action":"remove","lines":["g"],"id":188},{"start":{"row":17,"column":50},"end":{"row":17,"column":51},"action":"remove","lines":["n"]},{"start":{"row":17,"column":49},"end":{"row":17,"column":50},"action":"remove","lines":["i"]},{"start":{"row":17,"column":48},"end":{"row":17,"column":49},"action":"remove","lines":["r"]},{"start":{"row":17,"column":47},"end":{"row":17,"column":48},"action":"remove","lines":["e"]},{"start":{"row":17,"column":46},"end":{"row":17,"column":47},"action":"remove","lines":["e"]},{"start":{"row":17,"column":45},"end":{"row":17,"column":46},"action":"remove","lines":["n"]},{"start":{"row":17,"column":44},"end":{"row":17,"column":45},"action":"remove","lines":["i"]},{"start":{"row":17,"column":43},"end":{"row":17,"column":44},"action":"remove","lines":["g"]},{"start":{"row":17,"column":42},"end":{"row":17,"column":43},"action":"remove","lines":["n"]},{"start":{"row":17,"column":41},"end":{"row":17,"column":42},"action":"remove","lines":["e"]},{"start":{"row":17,"column":40},"end":{"row":17,"column":41},"action":"remove","lines":["_"]}],[{"start":{"row":17,"column":39},"end":{"row":17,"column":40},"action":"remove","lines":["/"],"id":189}],[{"start":{"row":18,"column":27},"end":{"row":18,"column":28},"action":"remove","lines":["e"],"id":190},{"start":{"row":18,"column":26},"end":{"row":18,"column":27},"action":"remove","lines":["r"]},{"start":{"row":18,"column":25},"end":{"row":18,"column":26},"action":"remove","lines":["a"]},{"start":{"row":18,"column":24},"end":{"row":18,"column":25},"action":"remove","lines":["w"]},{"start":{"row":18,"column":23},"end":{"row":18,"column":24},"action":"remove","lines":["t"]},{"start":{"row":18,"column":22},"end":{"row":18,"column":23},"action":"remove","lines":["f"]},{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"remove","lines":["o"]},{"start":{"row":18,"column":20},"end":{"row":18,"column":21},"action":"remove","lines":["s"]}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":21},"action":"insert","lines":["N"],"id":191},{"start":{"row":18,"column":21},"end":{"row":18,"column":22},"action":"insert","lines":["e"]}],[{"start":{"row":18,"column":20},"end":{"row":18,"column":22},"action":"remove","lines":["Ne"],"id":192},{"start":{"row":18,"column":20},"end":{"row":18,"column":49},"action":"insert","lines":["Network_Engineering_examples/"]}],[{"start":{"row":18,"column":69},"end":{"row":18,"column":70},"action":"remove","lines":["s"],"id":193},{"start":{"row":18,"column":68},"end":{"row":18,"column":69},"action":"remove","lines":["e"]},{"start":{"row":18,"column":67},"end":{"row":18,"column":68},"action":"remove","lines":["l"]},{"start":{"row":18,"column":66},"end":{"row":18,"column":67},"action":"remove","lines":["p"]},{"start":{"row":18,"column":65},"end":{"row":18,"column":66},"action":"remove","lines":["m"]},{"start":{"row":18,"column":64},"end":{"row":18,"column":65},"action":"remove","lines":["a"]},{"start":{"row":18,"column":63},"end":{"row":18,"column":64},"action":"remove","lines":["x"]},{"start":{"row":18,"column":62},"end":{"row":18,"column":63},"action":"remove","lines":["e"]},{"start":{"row":18,"column":61},"end":{"row":18,"column":62},"action":"remove","lines":["_"]},{"start":{"row":18,"column":60},"end":{"row":18,"column":61},"action":"remove","lines":["g"]},{"start":{"row":18,"column":59},"end":{"row":18,"column":60},"action":"remove","lines":["n"]},{"start":{"row":18,"column":58},"end":{"row":18,"column":59},"action":"remove","lines":["i"]},{"start":{"row":18,"column":57},"end":{"row":18,"column":58},"action":"remove","lines":["r"]},{"start":{"row":18,"column":56},"end":{"row":18,"column":57},"action":"remove","lines":["e"]},{"start":{"row":18,"column":55},"end":{"row":18,"column":56},"action":"remove","lines":["e"]},{"start":{"row":18,"column":54},"end":{"row":18,"column":55},"action":"remove","lines":["n"]},{"start":{"row":18,"column":53},"end":{"row":18,"column":54},"action":"remove","lines":["i"]},{"start":{"row":18,"column":52},"end":{"row":18,"column":53},"action":"remove","lines":["g"]},{"start":{"row":18,"column":51},"end":{"row":18,"column":52},"action":"remove","lines":["n"]},{"start":{"row":18,"column":50},"end":{"row":18,"column":51},"action":"remove","lines":["e"]},{"start":{"row":18,"column":49},"end":{"row":18,"column":50},"action":"remove","lines":["_"]},{"start":{"row":18,"column":48},"end":{"row":18,"column":49},"action":"remove","lines":["/"]}],[{"start":{"row":3,"column":31},"end":{"row":4,"column":0},"action":"insert","lines":["",""],"id":195}],[{"start":{"row":4,"column":0},"end":{"row":5,"column":66},"action":"insert","lines":["import gspread","from oauth2client.service_account import ServiceAccountCredentials"],"id":196}],[{"start":{"row":4,"column":0},"end":{"row":4,"column":14},"action":"remove","lines":["import gspread"],"id":197}],[{"start":{"row":0,"column":9},"end":{"row":1,"column":0},"action":"insert","lines":["",""],"id":198}],[{"start":{"row":1,"column":0},"end":{"row":1,"column":14},"action":"insert","lines":["import gspread"],"id":199}],[{"start":{"row":4,"column":31},"end":{"row":5,"column":0},"action":"remove","lines":["",""],"id":200}],[{"start":{"row":63,"column":0},"end":{"row":73,"column":0},"action":"remove","lines":["def save_conversation_log():","    # 保存先フォルダの存在確認と作成","    os.makedirs(log_folder, exist_ok=True)","    # 動的なファイル名を生成","    timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")","    log_file_path = os.path.join(log_folder, f\"conversation_log_{timestamp}.txt\")","    with open(log_file_path, \"w\", encoding=\"utf-8\") as log_file:","        for message in st.session_state.messages:","            role = \"ユーザー\" if message[\"role\"] == \"user\" else \"アシスタント\"","            log_file.write(f\"{role}: {message['content']}\\n\")",""],"id":201},{"start":{"row":63,"column":0},"end":{"row":79,"column":75},"action":"insert","lines":["# Google Sheets に接続","def get_gsheet():","    import json","    scope = [\"https://spreadsheets.google.com/feeds\", \"https://www.googleapis.com/auth/drive\"]","    creds_dict = json.loads(st.secrets[\"GSPREAD_SERVICE_ACCOUNT\"])","    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)","    client = gspread.authorize(creds)","    sheet = client.open(st.secrets[\"SHEET_NAME\"]).sheet1","    return sheet","","# 会話履歴を1行ずつGoogle Sheetsに保存","def save_conversation_log_to_sheet(student_id=\"anonymous\"):","    sheet = get_gsheet()","    timestamp = datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")","    for message in st.session_state.messages:","        role = \"ユーザー\" if message[\"role\"] == \"user\" else \"アシスタント\"","        sheet.append_row([timestamp, student_id, role, message[\"content\"]])"]}],[{"start":{"row":80,"column":0},"end":{"row":83,"column":25},"action":"remove","lines":["# 会話終了ボタン","if st.button(\"会話を終了\"):","    save_conversation_log()","    st.info(f\"会話が終了しました\")"],"id":202}],[{"start":{"row":80,"column":0},"end":{"row":81,"column":0},"action":"insert","lines":["",""],"id":203}],[{"start":{"row":81,"column":0},"end":{"row":90,"column":0},"action":"insert","lines":["# 学籍番号を最初に入力させる","if \"student_id\" not in st.session_state:","    st.session_state.student_id = st.text_input(\"あなたの学籍番号を入力してください（8桁）\")","    st.stop()","","# 会話終了ボタン押されたらGoogle Sheetsに保存","if st.button(\"会話を終了\"):","    save_conversation_log_to_sheet(student_id=st.session_state.student_id)","    st.info(f\"会話が終了しました\")",""],"id":204}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":0,"column":0},"end":{"row":91,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1743737183801,"hash":"49ae581a095c9b2a864d7aae1bf160259ba76002"}